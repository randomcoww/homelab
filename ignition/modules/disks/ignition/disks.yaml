---
variant: fcos
version: 1.5.0
systemd:
  units:
    %{~ for name, disk in disks ~}
    %{~ for partition in disk.partitions ~}
    - name: ${partition.mount_unit_name}.mount
      enabled: true
      contents: |
        [Unit]
        ConditionPathExists=${partition.device}

        [Mount]
        What=${partition.device}
        Where=${partition.mount_path}
        Type=${partition.format}
        Options=${join(",", partition.mount_options)}

        [Install]
        WantedBy=local-fs.target

    %{~ for bind_mount in partition.bind_mounts ~}
    - name: ${bind_mount.mount_unit_name}.mount
      enabled: true
      contents: |
        [Unit]
        Requires=${partition.mount_unit_name}.mount
        After=${partition.mount_unit_name}.mount

        [Mount]
        What=${partition.mount_path}/${bind_mount.relative_path}
        Where=${bind_mount.mount_path}
        Type=none
        Options=bind

        [Install]
        WantedBy=local-fs.target
    %{~ endfor ~}
    %{~ endfor ~}
    %{~ endfor ~}

storage:
  disks:
    %{~ for name, disk in disks ~}
    - device: ${disk.device}
      wipe_table: ${disk.wipe}
      partitions:
      %{~ for partition in disk.partitions ~}
      - label: ${partition.label}
        number: ${partition.number}
        start_mib: ${partition.start_mib}
        size_mib: ${partition.size_mib}
        wipe_partition_entry: ${partition.wipe}
      %{~ endfor ~}
    %{~ endfor ~}
  filesystems:
    %{~ for name, disk in disks ~}
    %{~ for partition in disk.partitions ~}
    - path: ${partition.mount_path}
      device: ${partition.device}
      format: ${partition.format}
      wipe_filesystem: ${partition.wipe}
      label: ${partition.label}
      %{~ if length(lookup(partition, "options", [])) > 0 ~}
      options:
        %{~ for option in partition.options ~}
        - ${option}
        %{~ endfor ~}
      %{~ endif ~}
    %{~ endfor ~}
    %{~ endfor ~}