# "AI Audit Read" = "19637fbb73d242c0a92845d8db0b95b1"
# "AI Audit Write" = "1ba6ab4cacdb454b913bbb93e1b8cb8c"
# "AI Gateway Read" = "4dc8917b4b40457d88d3035d5dadb054"
# "AI Gateway Run" = "644535f4ed854494a59cb289d634b257"
# "AI Gateway Write" = "6c8a3737f07f46369c1ea1f22138daaf"
# "API Tokens Read" = "0cc3a61731504c89b99ec1be78b77aa0"
# "API Tokens Write" = "686d18d5ac6c441c867cbf6771e58a0a"
# "Access: Apps and Policies Read" = "7ea222f6d5064cfa89ea366d7c1fee89"
# "Access: Apps and Policies Revoke" = "6c9d1cfcfc6840a987d1b5bfb880a841"
# "Access: Apps and Policies Write" = "1e13c5124ca64b72b1969a67e8829049"
# "Access: Audit Logs Read" = "b05b28e839c54467a7d6cba5d3abb5a3"
# "Access: Certificates Read" = "4f3196a5c95747b6ad82e34e1d0a694f"
# "Access: Certificates Write" = "29d3afbfd4054af9accdd1118815ed05"
# "Access: Custom Page Read" = "08e61dabe81a422dab0dea6fdef1a98a"
# "Access: Custom Page Write" = "4e5fd8ac327b4a358e48c66fcbeb856d"
# "Access: Device Posture Read" = "0f4841f80adb4bada5a09493300e7f8d"
# "Access: Device Posture Write" = "2fc1072ee6b743828db668fcb3f9dee7"
# "Access: Organizations, Identity Providers, and Groups Read" = "26bc23f853634eb4bff59983b9064fde"
# "Access: Organizations, Identity Providers, and Groups Revoke" = "7121a0c7e9ed46e3829f9cca2bb572aa"
# "Access: Organizations, Identity Providers, and Groups Write" = "bfe0d8686a584fa680f4c53b5eb0de6d"
# "Access: Population Read" = "de99c87e48d642ce8c985d027905b475"
# "Access: Population Write" = "bc783549a3a741aaa10556faf8b485bb"
# "Access: SSH Auditing CA Read" = "99ff99e4e30247a99d3777a8c4c18541"
# "Access: SSH Auditing CA Write" = "d30c9ad8b5224e7cb8d41bcb4757effc"
# "Access: Service Tokens Read" = "91f7ce32fa614d73b7e1fc8f0e78582b"
# "Access: Service Tokens Write" = "a1c0fec57cf94af79479a6d827fa518c"
# "Account API Gateway" = "5e5d3e8efeec49f3afb67bafecbcd511"
# "Account API Gateway Read" = "05a2a65760a546439ed29762b163cece"
# "Account API Tokens Read" = "eb56a6953c034b9d97dd838155666f06"
# "Account API Tokens Write" = "5bc3f8b21c554832afc660159ab75fa4"
# "Account Analytics Read" = "b89a480218d04ceb98b4fe57ca29dc1f"
# "Account Custom Pages Read" = "c57ea647ef654b47bc8944fa739b570d"
# "Account Custom Pages Write" = "8a9d35a7c8504208ad5c3e8d58e6162d"
# "Account DNS Settings Read" = "cfa964bcdafc4ab39704e7476154e41b"
# "Account DNS Settings Write" = "dc44f27f48ab405392a5f69fe822bd01"
# "Account Firewall Access Rules Read" = "de7a688cc47d43bd9ea700b467a09c96"
# "Account Firewall Access Rules Write" = "a416acf9ef5a4af19fb11ed3b96b1fe6"
# "Account Rule Lists Read" = "4f1071168de8466e9808de86febfc516"
# "Account Rule Lists Write" = "2edbf20661fd4661b0fe10e9e12f485c"
# "Account Rulesets Read" = "fb39996ee9044d2a8725921e02744b39"
# "Account Rulesets Write" = "56907406c3d548ed902070ec4df0e328"
# "Account Settings Read" = "c1fde68c7bcc44588cbb6ddbc16d6480"
# "Account Settings Write" = "1af1fa2adc104452b74a9a3364202f20"
# "Account WAF Read" = "56b2af4817c84ad99187911dc3986c23"
# "Account WAF Write" = "cde8c82463b6414ca06e46b9633f52a6"
# "Account: SSL and Certificates Read" = "a7a233f9604845c787d4c8c39ac09c21"
# "Account: SSL and Certificates Write" = "db37e5f1cb1a4e1aabaef8deaea43575"
# "Address Maps Read" = "d07270cea5484b08ad6440c985af2148"
# "Address Maps Write" = "6ffe7f4299db4d4cb54f64e0eb12a456"
# "Allow Request Tracer Read" = "f3604047d46144d2a3e9cf4ac99d7f16"
# "Analytics Read" = "9c88f9c5bce24ce7af9a958ba9c504db"
# "Apps Write" = "094547ab6e77498c8c4dfa87fadd5c51"
# "Argo Tunnel Read" = "efea2ab8357b47888938f101ae5e053f"
# "Argo Tunnel Write" = "c07321b023e944ff818fec44d8203567"
# "Billing Read" = "7cf72faf220841aabcfdfab81c43c4f6"
# "Billing Write" = "6c80e02421494afc9ae14414ed442632"
# "Bot Management Feedback Report Read" = "51be404b56244056868226263a44a632"
# "Bot Management Feedback Report Write" = "2002629aaff0454085bf5a201ed70a72"
# "Bot Management Read" = "07bea2220b2343fa9fae15656c0d8e88"
# "Bot Management Write" = "3b94c49258ec4573b06d51d99b6416c0"
# "Browser Rendering Read" = "374b03fa229f4eb6b011bb1cd7f235ee"
# "Browser Rendering Write" = "adddda876faa4a0590f1b23a038976e4"
# "Cache Purge" = "e17beae8b8cb423a99b1730f21238bed"
# "Cache Settings Read" = "3245da1cf36c45c3847bb9b483c62f97"
# "Cache Settings Write" = "9ff81cbbe65c400b97d92c3c1033cab6"
# "Calls Read" = "686ab9a8b3854f25a1474f302d14b68d"
# "Calls Write" = "b711942448db4b0aace44d1312f9fdb0"
# "China Network Steering Read" = "9ade9cfc8f8949bcb2371be2f0ec8db1"
# "China Network Steering Write" = "c6f6338ceae545d0b90daaa1fed855e6"
# "Cloud Connector Read" = "0661ff47aa3a4786beab3b8128e0cd24"
# "Cloud Connector Write" = "eafd71286d0e4fdca404a7b4d203c5c9"
# "Cloud Email Security: Read" = "9e5a9912439940fca5898b5b8dc6d1a5"
# "Cloud Email Security: Write" = "a3567c13e074447fb101babac3463566"
# "Cloudchamber Read" = "65ec50cbde3d4c838bbe7500024d5745"
# "Cloudchamber Write" = "26ce6c7d18a346528e7b905d5e269866"
# "Cloudflare CDS Compute Account Read" = "00ec19a0d4fa4e4aae23b50bf04c0630"
# "Cloudflare CDS Compute Account Write" = "9bf884ba0de445dab37ea4a3e1a2c9f1"
# "Cloudflare DEX" = "3a1e1ef09dd34271bb44fc4c6a419952"
# "Cloudflare DEX Read" = "3b376e0aa52c41cbb6afc9cab945afa8"
# "Cloudflare DEX Write" = "92c8dcd551cc42a6a57a54e8f8d3f3e3"
# "Cloudflare One Connectors Read" = "07cf1c1952a84b13b2cd542f3d2f29ab"
# "Cloudflare One Connectors Write" = "a7030c9c98d544e092d8b099fabb1f06"
# "Cloudflare One Networks Read" = "4f1276d1e7e34c32a5012bbe02ece86d"
# "Cloudflare One Networks Write" = "e2980d9241cf4939bbbd74fdc43b9651"
# "Cloudflare One Warp Connectors Read" = "1cd960c063a0448481343372c963d8c7"
# "Cloudflare One Warp Connectors Write" = "5b5c774a5d174ca88d046c8889648b3f"
# "Cloudflare One cloudflared Connectors Read" = "c1968d31028d4239976ec3bc4750bbf6"
# "Cloudflare One cloudflared Connectors Write" = "037b9e348b3b42d4b46ea2fcb1cfb3e7"
# "Cloudflare Zero Trust PII Read" = "f5d857f67f144e3c8bacea88c17d4a13"
# "Cloudforce One Read" = "cf9353ed7978436e8fb20c03fce26449"
# "Cloudforce One Write" = "677767156f294485b497a8f103172e7d"
# "Config Settings Read" = "20e5ea084b2f491c86b8d8d90abff905"
# "Config Settings Write" = "06f0526e6e464647bd61b63c54935235"
# "Constellation Read" = "eeffa4d16812430cb4a0ae9e7f46fc24"
# "Constellation Write" = "7c81856725af47ce89a790d5fb36f362"
# "Custom Errors Read" = "a2b55cd504d44ef18b7ba6a7f2b8fbb1"
# "Custom Errors Write" = "a9dba34cf5814d4ab2007b4ada0045bd"
# "Custom Pages Read" = "a2431ca73b7d41f99c53303027392586"
# "Custom Pages Write" = "c244ec076974430a88bda1cdd992d0d9"
# "D1 Read" = "192192df92ee43ac90f2aeeffce67e35"
# "D1 Write" = "09b2857d1c31407795e75e3fed8617a1"
# "DDoS Botnet Feed Read" = "dee7c22a57674abea8f942110b094717"
# "DDoS Botnet Feed Write" = "0caa90c9b186447397c8b00358d34a76"
# "DDoS Protection Read" = "af1c363c35ba45b9a8c682ae50eb3f99"
# "DDoS Protection Write" = "d44ed14bcc4340b194d3824d60edad3f"
# "DNS Firewall Read" = "5f48a472240a4b489a21d43bd19a06e1"
# "DNS Firewall Write" = "da6d2d6f2ec8442eaadda60d13f42bca"
# "DNS Read" = "82e64a83756745bbbb1c9c2701bf816b"
# "DNS View Read" = "95d69e8d6d5144bfb0923667355d9f11"
# "DNS View Write" = "5b7aedd821a548b9bf5a2acabbce98c7"
# "DNS Write" = "4755a26eedb94da69e1066d98aa820be"
# "Disable ESC Read" = "29eefa0805f94fdfae2b058b5b52f319"
# "Disable ESC Write" = "18555e39c5ba40d284dde87eda845a90"
# "Domain API Gateway" = "f0235726de25444a84f704b7c93afadf"
# "Domain API Gateway Read" = "6ced5d0d69b1422396909a62c38ab41b"
# "Domain Page Shield" = "6134079371904d8ebd77931c8ca07e50"
# "Domain Page Shield Read" = "945315185a8f40518bf3e9e6d0bee126"
# "Dynamic URL Redirects Read" = "d8e12db741544d1586ec1d6f5d3c7786"
# "Dynamic URL Redirects Write" = "74e1036f577a48528b78d2413b40538d"
# "Email Routing Addresses Read" = "5272e56105d04b5897466995b9bd4643"
# "Email Routing Addresses Write" = "e4589eb09e63436686cd64252a3aebeb"
# "Email Routing Rules Read" = "1b600d9d8062443e986a973f097e728a"
# "Email Routing Rules Write" = "79b3ec0d10ce4148a8f8bdc0cc5f97f2"
# "Email Security DMARC Reports Read" = "1047880d37b649b49db4a504a245896f"
# "Email Security DMARC Reports Write" = "2eee71c9364c4cacaf469e8370f09056"
# "Firewall Services Read" = "4ec32dfcb35641c5bb32d5ef1ab963b4"
# "Firewall Services Write" = "43137f8d07884d3198dc0ee77ca6e79b"
# "Fraud Detection Read" = "0d24e472a9654642a97df736e8b0d980"
# "Fraud Detection Write" = "685f9605fd4e44ec937b6a0db658e629"
# "HTTP Applications Read" = "6b60a5a87cae475da7e76e77e4209dd5"
# "HTTP Applications Write" = "4736c02a9f224c8196ae5b127beae78c"
# "HTTP DDoS Managed Ruleset Read" = "c49f8d15f9f44885a544d945ef5aa6ae"
# "HTTP DDoS Managed Ruleset Write" = "b88a3aa889474524bccea5cf18f122bf"
# "Health Checks Read" = "fac65912d42144aa86b7dd33281bf79e"
# "Health Checks Write" = "e0dc25a0fbdf4286b1ea100e3256b0e3"
# "Hyperdrive Read" = "4d62ccf834df44808bc9283d65c4e4e9"
# "Hyperdrive Write" = "721b2f51fba74871bd361de65aeb7e03"
# "IOT Read" = "212c9ff247b9406d990c017482afb3a5"
# "IOT Write" = "865ebd55bc6d4b109de6813eccfefd13"
# "IP Prefixes: BGP On Demand Read" = "e763fae6ee95443b8f56f19213c5f2a5"
# "IP Prefixes: BGP On Demand Write" = "2ae23e4939d54074b7d252d27ce75a77"
# "IP Prefixes: Read" = "27beb7f8333b41e2b946f0e23cd8091e"
# "IP Prefixes: Write" = "92b8234e99f64e05bbbc59e1dc0f76b6"
# "Images Read" = "0cf6473ad41449e7b7b743d14fc20c60"
# "Images Write" = "618ec6c64a3a42f8b08bdcb147ded4e4"
# "Integration Write" = "c6f97eeee13345db8cc00af0953a42de"
# "Intel Read" = "df1577df30ee46268f9470952d7b0cdf"
# "Intel Write" = "92209474242d459690e2cdb1985eaa6c"
# "L4 DDoS Managed Ruleset Read" = "4657621393f94f83b8ef94adba382e48"
# "L4 DDoS Managed Ruleset Write" = "7a4c3574054a4d0ba7c692893ba8bdd4"
# "Load Balancers Account Read" = "59059f0c977b44f8b1c18e0aaf91c369"
# "Load Balancers Account Write" = "419ec42810af4659ade77716dbe47bc6"
# "Load Balancers Read" = "e9a975f628014f1d85b723993116f7d5"
# "Load Balancers Write" = "6d7f2f5f5b1d4a0e9081fdc98d432fd1"
# "Load Balancing: Monitors and Pools Read" = "9d24387c6e8544e2bc4024a03991339f"
# "Load Balancing: Monitors and Pools Write" = "d2a1802cc9a34e30852f8b33869b2f3c"
# "Logs Read" = "c4a30cd58c5d42619c86a3c36c441e2d"
# "Logs Write" = "3e0b5820118e47f3922f7c989e673882"
# "Magic Firewall Packet Captures - Read PCAPs API" = "3a46c728a0a040d5a65cd8e2f3bc6935"
# "Magic Firewall Packet Captures - Write PCAPs API" = "4ea7d6421801452dbf07cef853a5ef39"
# "Magic Firewall Read" = "02b71f12bb0748e9af8126494e181342"
# "Magic Firewall Write" = "8bd1dac84d3d43e7bfb43145f010a15c"
# "Magic Network Monitoring Admin" = "8e6ed1ef6e864ad0ae477ceffa5aa5eb"
# "Magic Network Monitoring Config Read" = "3d85e9514f944bb4912c5871d92e5af5"
# "Magic Network Monitoring Config Write" = "09c77baecb6341a2b1ca2c62b658d290"
# "Magic Transit Prefix Read" = "967ecf860a244dd1911a0331a0af582a"
# "Magic Transit Prefix Write" = "0bc09a3cd4b54605990df4e307f138e1"
# "Managed headers Read" = "319f5059d33a410da0fac4d35a716157"
# "Managed headers Write" = "0fd9d56bc2da43ad8ea22d610dd8cab1"
# "Mass URL Redirects Read" = "429a068902904c5a9ed9fc267c67da9a"
# "Mass URL Redirects Write" = "abe78e2276664f4db588c1f675a77486"
# "Memberships Read" = "3518d0f75557482e952c6762d3e64903"
# "Memberships Write" = "9201bc6f42d440968aaab0c6f17ebb1d"
# "Notifications Read" = "ce18edbdcebf465e9d6d1d2fc80ffd42"
# "Notifications Write" = "c3c847c5802d4ce3ba00e3e97b3c8555"
# "Origin Read" = "7b32a91ece3140d4b3c2c56f23fc8e35"
# "Origin Write" = "a4308c6855c84eb2873e01b6cc85cbb3"
# "Page Rules Read" = "b415b70a4fd1412886f164451f20405c"
# "Page Rules Write" = "ed07f6c337da4195b4e72a1fb2c6bcae"
# "Page Shield" = "440e6958bcc947329f8d56328d7322ce"
# "Page Shield Read" = "050531528b044d58bbb71666fef7c07c"
# "Page Shield Write" = "87065285ab38463481e72815eefd18c3"
# "Pages Read" = "e247aedd66bd41cc9193af0213416666"
# "Pages Write" = "8d28297797f24fb8a0c332fe0866ec89"
# "Pipelines Read" = "14b9cf2f410f4c0c9a16bb10a81c0e0b"
# "Pipelines Send" = "5606e7405dc542949d949d59993d321f"
# "Pipelines Write" = "e34111af393449539859485aa5ddd5bd"
# "Pubsub Configuration Read" = "fd7f886c75a244389e892c4c3c068292"
# "Pubsub Configuration Write" = "910b6ecca1c5411bb894e787362d1312"
# "Queues Read" = "84a7755d54c646ca87cd50682a34bf7c"
# "Queues Write" = "366f57075ffc42689627bcf8242a1b6d"
# "Radar Read" = "dfe525ec7b07472c827d8d009178b2ac"
# "Response Compression Read" = "93ae59e7a40c4287a57ff6e501186a63"
# "Response Compression Write" = "4bd3fb513a23494aa1341a7e1eb6e080"
# "Rule Policies Read" = "58abbad6d2ce40abb2594fbe932a2e0e"
# "Rule Policies Write" = "61ddc58f1da14f95b33b41213360cbeb"
# "SCIM Provisioning" = "d5812c023a5048b4882175a28952362d"
# "SSL and Certificates Read" = "7b7216b327b04b8fbc8f524e1f9b7531"
# "SSL and Certificates Write" = "c03055bc037c4ea9afb9a9f104b7b721"
# "Sanitize Read" = "853643ed57244ed1a05a7c024af9ab5a"
# "Sanitize Write" = "89bb8c37d46042e98b84560eaaa6379f"
# "Select Configuration Read" = "595409c54a24444b80a495620b2d614c"
# "Select Configuration Write" = "235eac9bb64942b49cb805cc851cb000"
# "Snippets Read" = "74c654eb4aac40e28d6c6caa4c5aeb3d"
# "Snippets Write" = "dadeaf3abdf14126a77a35e0c92fc36e"
# "Stream Read" = "de21485a24744b76a004aa153898f7fe"
# "Stream Write" = "714f9c13a5684c2885a793f5edb36f59"
# "Teams Read" = "3f376c8e6f764a938b848bd01c8995c4"
# "Teams Report" = "efb81b5cd37d49f3be1da9363a6d7a19"
# "Teams Write" = "b33f02c6f7284e05a6f20741c0bb0567"
# "Transform Rules Read" = "a9a99455bf3245f6a5a244f909d74830"
# "Transform Rules Write" = "ae16e88bc7814753a1894c7ce187ab72"
# "Trust and Safety Read" = "f0ba3733e746429182fcd40ec648c066"
# "Trust and Safety Write" = "120f843a9c074f399b830e542e5616b8"
# "Turnstile Sites Read" = "5d78fd7895974fd0bdbbbb079482721b"
# "Turnstile Sites Write" = "755c05aa014b4f9ab263aa80b8167bd8"
# "URL Scanner Read" = "5d613a610b294788a29572aaac2f254d"
# "URL Scanner Write" = "2a400bcb29154daab509fe07e3facab0"
# "User Details Read" = "8acbe5bb0d54464ab867149d7f7cf8ac"
# "User Details Write" = "55a5e17cc99e4a3fa1f3432d262f2e55"
# "Vectorize Read" = "1799edaae5db489294430e20d9b519e0"
# "Vectorize Write" = "64156ba5be47441096c83c7fc17c488b"
# "Waiting Rooms Read" = "cab5202d07ef47beae788e6bc95cb6fe"
# "Waiting Rooms Write" = "24fc124dc8254e0db468e60bf410c800"
# "Web3 Hostnames Read" = "8e31f574901c42e8ad89140b28d42112"
# "Web3 Hostnames Write" = "5ea6da42edb34811a78d1b007557c0ca"
# "Workers AI Read" = "a92d2450e05d4e7bb7d0a64968f83d11"
# "Workers AI Write" = "bacc64e0f6c34fc0883a1223f938a104"
# "Workers CI Read" = "ad99c5ae555e45c4bef5bdf2678388ba"
# "Workers CI Write" = "2e095cf436e2455fa62c9a9c2e18c478"
# "Workers KV Storage Read" = "8b47d2786a534c08a1f94ee8f9f599ef"
# "Workers KV Storage Write" = "f7f0eda5697f475c90846e879bab8666"
# "Workers R2 Storage Bucket Item Read" = "6a018a9f2fc74eb6b293b0c548f38b39"
# "Workers R2 Storage Bucket Item Write" = "2efd5506f9c8494dacb1fa10a3e7d5b6"
# "Workers R2 Storage Read" = "b4992e1108244f5d8bfbd5744320c2e1"
# "Workers R2 Storage Write" = "bf7481a1826f439697cb59a20b22293e"
# "Workers Routes Read" = "2072033d694d415a936eaeb94e6405b8"
# "Workers Routes Write" = "28f4b596e7d643029c524985477ae49a"
# "Workers Scripts Read" = "1a71c399035b4950a1bd1466bbe4f420"
# "Workers Scripts Write" = "e086da7e2179491d91ee5f35b3ca210a"
# "Workers Tail Read" = "05880cd1bdc24d8bae0be2136972816b"
# "Zaraz Admin" = "cdeb15b336e640a2965df8c65052f1e0"
# "Zaraz Edit" = "89d5bf002389496e9994b8c30608b5d0"
# "Zaraz Read" = "5bdbde7e76144204a244274eac3eb0eb"
# "Zero Trust: Seats Write" = "a1a6298e52584c8fb6313760a30c681e"
# "Zone DNS Settings Read" = "0a6cfe8cd3ed445e918579e2fb13087b"
# "Zone DNS Settings Write" = "c4df38be41c247b3b4b7702e76eadae0"
# "Zone Read" = "c8fed203ed3043cba015a93ad1616f1f"
# "Zone Settings Read" = "517b21aee92c4d89936c976ba6e4be55"
# "Zone Settings Write" = "3030687196b94b638145a3953da2b699"
# "Zone Transform Rules Read" = "211a4c0feb3e43b3a2d41f1443a433e7"
# "Zone Transform Rules Write" = "0ac90a90249747bca6b047d97f0803e9"
# "Zone Versioning Read" = "1b1ea24cf0904d33903f0cc7e54e280f"
# "Zone Versioning Write" = "c9915d86fbff46af9dd945c0a882294b"
# "Zone WAF Read" = "dbc512b354774852af2b5a5f4ba3d470"
# "Zone WAF Write" = "fb6778dc191143babbfaa57993f1d275"
# "Zone Write" = "e6d2666161e84845a636613608cee8d5"

locals {
  cloudflare_account_id = data.cloudflare_accounts.accounts.accounts[0].id

  r2_buckets = {
    etcd = {
      bucket = "etcd-snapshot"
    }
    documents = {
      bucket = "documents"
    }
    pictures = {
      bucket = "pictures"
    }
    music = {
      bucket = "music"
    }
  }
  cloudflare_tunnels = {
    # type = map(object({
    #   zone              = string
    #   path              = string
    #   country_whitelist = list(string)
    #   service           = string
    # }))
    public = {
      zone = local.domains.public
      path = "/"
      country_whitelist = [
        "US", "JP",
      ]
      service = "https://${local.kubernetes_services.ingress_nginx_external.endpoint}"
    }
  }
}

data "cloudflare_accounts" "accounts" {
}

data "cloudflare_api_token_permission_groups" "all" {
}

# R2 buckets

resource "cloudflare_r2_bucket" "bucket" {
  for_each   = local.r2_buckets
  account_id = local.cloudflare_account_id
  name       = each.key
}

resource "cloudflare_api_token" "r2_bucket" {
  for_each = local.r2_buckets
  name     = "r2-${each.key}"
  policy {
    permission_groups = [
      data.cloudflare_api_token_permission_groups.all.r2["Workers R2 Storage Bucket Item Read"],
      data.cloudflare_api_token_permission_groups.all.r2["Workers R2 Storage Bucket Item Write"],
    ]
    resources = {
      "com.cloudflare.edge.r2.bucket.${local.cloudflare_account_id}_default_${each.key}" = "*"
    }
  }
}

# DNS

resource "cloudflare_api_token" "dns" {
  name = "zone-dns"
  policy {
    permission_groups = [
      data.cloudflare_api_token_permission_groups.all.zone["DNS Write"],
      data.cloudflare_api_token_permission_groups.all.zone["Zone Read"],
    ]
    resources = {
      "com.cloudflare.api.account.zone.*" = "*"
    }
  }
}

# Zero trust

resource "cloudflare_zero_trust_gateway_certificate" "tunnel" {
  account_id      = local.cloudflare_account_id
  activate        = true
  gateway_managed = true
}

# CF tunnel

data "cloudflare_zone" "zone" {
  for_each = local.cloudflare_tunnels
  name     = each.value.zone
}

resource "cloudflare_zone_settings_override" "zone" {
  for_each = local.cloudflare_tunnels
  zone_id  = data.cloudflare_zone.zone[each.key].id
  settings {
    always_use_https         = "on"
    tls_1_3                  = "on"
    automatic_https_rewrites = "on"
    ssl                      = "full"
    min_tls_version          = "1.3"
    opportunistic_encryption = "on"
    universal_ssl            = "on"
    websockets               = "on"
  }
}

resource "cloudflare_ruleset" "geo_filter" {
  for_each = local.cloudflare_tunnels
  zone_id  = data.cloudflare_zone.zone[each.key].id
  name     = "Geo-block"
  kind     = "zone"
  phase    = "http_request_firewall_custom"

  rules {
    action     = "block"
    expression = "(not ip.geoip.country in {\"${join("\" \"", each.value.country_whitelist)}\"})"
    enabled    = true
  }
}

resource "random_id" "cloudflare_tunnel_secret" {
  for_each    = local.cloudflare_tunnels
  byte_length = 35
}

resource "cloudflare_zero_trust_tunnel_cloudflared" "tunnel" {
  for_each   = local.cloudflare_tunnels
  name       = each.key
  account_id = local.cloudflare_account_id
  secret     = random_id.cloudflare_tunnel_secret[each.key].b64_std
}

resource "cloudflare_zero_trust_tunnel_cloudflared_config" "tunnel" {
  for_each   = local.cloudflare_tunnels
  account_id = local.cloudflare_account_id
  tunnel_id  = cloudflare_zero_trust_tunnel_cloudflared.tunnel[each.key].id
  config {
    ingress_rule {
      hostname = "*.${each.value.zone}"
      service  = each.value.service
      path     = each.value.path
      # need to remove default params from terrafrom
      origin_request {
        http2_origin           = true
        no_tls_verify          = true
        tls_timeout            = "0s"
        proxy_address          = ""
        tcp_keep_alive         = "0s"
        connect_timeout        = "0s"
        keep_alive_timeout     = "0s"
        keep_alive_connections = 0
      }
    }
    ingress_rule {
      service = "http_status:404"
    }
  }
}

resource "cloudflare_record" "record" {
  for_each = local.cloudflare_tunnels
  zone_id  = data.cloudflare_zone.zone[each.key].id
  name     = "*"
  content  = "${cloudflare_zero_trust_tunnel_cloudflared.tunnel[each.key].id}.cfargotunnel.com"
  type     = "CNAME"
  proxied  = true
}