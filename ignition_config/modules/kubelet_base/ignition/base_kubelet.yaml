---
variant: fcos
version: 1.4.0
systemd:
  units:
    - name: crio.service
      enabled: true
      dropins:
        - name: 10-local-fs-wait.conf
          contents: |
            [Unit]
            Wants=local-fs.target
            After=local-fs.target
    - name: kubelet.service
      enabled: true
      dropins:
        - name: 10-masterless-common.conf
          contents: |
            [Unit]
            Wants=crio.service
            After=crio.service
            Wants=local-fs.target
            After=local-fs.target

            [Service]
            Environment=KUBELET_COMMON_ARGS="--exit-on-lock-contention \
              --lock-file=/var/run/lock/kubelet.lock \
              --node-ip=${node_ip} \
              --v=2"
            ExecStartPre=/usr/bin/mkdir -p \
              ${static_pod_manifest_path}
            ExecStart=
            ExecStart=/usr/bin/kubelet \
              $KUBELET_COMMON_ARGS \
              --config=${config_path}/kubelet-config.yaml

storage:
  files:
    # Enable node graceful shutdown
    - path: /etc/systemd/logind.conf.d/10-kubelet-graceful-shutdown.conf
      contents:
        inline: |
          [Login]
          InhibitDelayMaxSec=180

    - path: /etc/crio/crio.conf.d/10-custom.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [crio.runtime]
          default_runtime="crun"
          hooks_dir=["/usr/share/containers/oci/hooks.d"]
          selinux=true

          [crio.runtime.runtimes.crun]
          runtime_path="/usr/bin/crun"

          [crio.network]
          plugin_dirs=["/usr/libexec/cni/","/opt/cni/bin/"]

          [crio.metrics]
          enable_metrics=false

          [crio.tracing]
          enable_tracing=false
    - path: ${config_path}/kubelet-config.yaml
      mode: 0644
      contents:
        inline: |
          kind: KubeletConfiguration
          apiVersion: kubelet.config.k8s.io/v1beta1
          containerRuntimeEndpoint: unix:///run/crio/crio.sock
          cgroupDriver: systemd
          cgroupsPerQOS: false
          authentication:
            anonymous:
              enabled: true
            webhook:
              enabled: false
          authorization:
            mode: AlwaysAllow
          enableServer: false
          staticPodPath: ${static_pod_manifest_path}
          makeIPTablesUtilChains: false
          shutdownGracePeriodByPodPriority:
          - priority: 0
            shutdownGracePeriodSeconds: 180
          containerLogMaxSize: 10Mi
          containerLogMaxFiles: 2
          registerNode: false
          failSwapOn: false
          enforceNodeAllocatable: []
