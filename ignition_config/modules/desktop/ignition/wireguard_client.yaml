---
variant: fcos
version: 1.5.0
storage:
  files:
    - path: /etc/systemd/network/12-wg0.netdev
      contents:
        inline: |
          [NetDev]
          Name=wg0
          Kind=wireguard

          [WireGuard]
          FirewallMark=0x8888
          ListenPort=51820
          RouteTable=off
          PrivateKey=${wireguard_client.Interface.PrivateKey}

          [WireGuardPeer]
          PublicKey=${wireguard_client.Peer.PublicKey}
          %{~ for k in split(",", wireguard_client.Peer.AllowedIPs) ~}
          AllowedIPs=${k}
          %{~ endfor ~}
          Endpoint=${wireguard_client.Peer.Endpoint}
    - path: /etc/systemd/network/20-wg0.network
      contents:
        inline: |
          [Match]
          Name=wg0

          [Link]
          ActivationPolicy=manual

          [Network]
          %{~ for k in split(",", wireguard_client.Interface.Address) ~}
          Address=${k}
          %{~ endfor ~}

          [RoutingPolicyRule]
          Family=both
          SuppressPrefixLength=0
          Priority=999
          Table=main

          [RoutingPolicyRule]
          Family=both
          FirewallMark=0x8888
          InvertRule=true
          Table=1000
          Priority=1000
          %{~ for k in split(",", wireguard_client.Peer.AllowedIPs) ~}

          [Route]
          Gateway=${element(split("/", k), 0)}
          Table=1000
          %{~ endfor ~}