---
variant: fcos
version: 1.5.0
systemd:
  units:
    # /usr/bin is read-only - copy to /opt/bin to modify
    - name: copy-sunshine.service
      enabled: true
      contents: |
        [Service]
        Type=oneshot
        RemainAfterExit=true
        ExecStartPre=/usr/bin/mkdir -p /opt/bin
        ExecStartPre=/usr/bin/cp -Ln /usr/bin/sunshine /opt/bin
        ExecStart=/usr/sbin/setcap cap_sys_admin+p /opt/bin/sunshine

        [Install]
        WantedBy=graphical.target

storage:
  files:
    - path: /etc/skel/.config/sunshine/apps.json
      mode: 0644
      contents:
        inline: |
          ${indent(10, jsonencode(sunshine.apps))}

    # systemd user unit
    # ignition doesn't support systemd --user
    # these dependencies work for gnome wayland
    # register client: curl http://localhost:47989/pin/<PIN>
    - path: /etc/systemd/user/sunshine.service
      mode: 0644
      contents:
        inline: |
          [Unit]
          Wants=gnome-session-initialized.target
          After=gnome-session-initialized.target
          Wants=copy-sunshine.service
          After=copy-sunshine.service
          ConditionKernelCommandLine=ignition.config.url

          [Service]
          Slice=session.slice
          ExecStart=/opt/bin/sunshine ${join(" ", [
            for k, v in sunshine.config :
            "${k}=${v}"
          ])}
          Restart=on-failure
  links:
    - path: /etc/systemd/user/graphical-session.target.wants/sunshine.service
      target: /etc/systemd/user/sunshine.service