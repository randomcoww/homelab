---
variant: fcos
version: 1.5.0
storage:
  files:
    - path: ${static_pod_manifest_path}/etcd-wrapper.yaml
      mode: 0644
      contents:
        inline: |
          ---
          kind: Pod
          apiVersion: v1
          metadata:
            namespace: kube-system
            name: etcd-wrapper
          spec:
            priorityClassName: system-node-critical
            priority: 2000001000
            hostNetwork: true
            restartPolicy: Always
            containers:
            - name: etcd-wrapper
              image: ${container_images.etcd_wrapper}
              args:
              - --name=$(NODE_NAME)
              - --host-cert-file=${pki.cert.path}
              - --host-key-file=${pki.key.path}
              - --host-trusted-ca-file=${pki.ca_cert.path}
              - --host-peer-cert-file=${pki.peer_cert.path}
              - --host-peer-key-file=${pki.peer_key.path}
              - --host-peer-trusted-ca-file=${pki.peer_ca_cert.path}
              - --initial-advertise-peer-urls=${initial_advertise_peer_urls}
              - --listen-peer-urls=${listen_peer_urls}
              - --advertise-client-urls=${advertise_client_urls}
              - --listen-client-urls=${listen_client_urls}
              - --initial-cluster-token=${cluster_token}
              - --initial-cluster=${initial_cluster}
              - --host-backup-file=${etcd_snapshot_path}
              - --host-etcd-manifest-file=${static_pod_manifest_path}/${etcd_pod_manifest_file}
              - --etcd-image=${container_images.etcd}
              - --client-cert-file=${pki.client_cert.path}
              - --client-key-file=${pki.client_key.path}
              - --initial-cluster-clients=${initial_cluster_clients}
              - --s3-backup-path=${backup_resource.resource}
              - --backup-interval=30m
              - --healthcheck-interval=10s
              - --pod-update-wait=60s
              env:
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              - name: AWS_ACCESS_KEY_ID
                value: "${backup_resource.access_key_id}"
              - name: AWS_SECRET_ACCESS_KEY
                value: "${backup_resource.secret_access_key}"
              - name: AWS_DEFAULT_REGION
                value: "${backup_resource.aws_region}"
              - name: AWS_SDK_LOAD_CONFIG
                value: "1"
              volumeMounts:
              - name: certs-volume
                mountPath: ${pki_path}
                readOnly: true
              - name: backup-volume
                mountPath: ${dirname(etcd_snapshot_path)}
              - name: manifest-volume
                mountPath: ${static_pod_manifest_path}
            volumes:
            - name: certs-volume
              hostPath:
                path: ${pki_path}
            - name: backup-volume
              hostPath:
                path: ${dirname(etcd_snapshot_path)}
            - name: manifest-volume
              hostPath:
                path: ${static_pod_manifest_path}

    # certs #
    %{~ for cert in values(pki) ~}
    - path: ${cert.path}
      mode: 0644
      contents:
        inline: "${replace(cert.content, "\n", "\\n")}"
    %{~ endfor ~}