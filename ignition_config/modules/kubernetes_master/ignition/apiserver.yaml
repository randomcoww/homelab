---
variant: fcos
version: 1.5.0
storage:
  files:
    - path: ${static_pod_manifest_path}/kube-apiserver.yaml
      mode: 0644
      contents:
        inline: |
          ---
          kind: Pod
          apiVersion: v1
          metadata:
            namespace: kube-system
            name: kube-apiserver
          spec:
            priorityClassName: system-node-critical
            priority: 2000001000
            hostNetwork: true
            restartPolicy: Always
            containers:
            - name: kube-apiserver
              image: ${container_images.kube_apiserver}
              command:
              - kube-apiserver
              - --advertise-address=$(NODE_IP)
              - --allow-privileged=true
              - --authorization-mode=Node,RBAC
              - --bind-address=0.0.0.0
              - --client-ca-file=${pki.ca_cert.path}
              - --etcd-cafile=${etcd_pki.ca_cert.path}
              - --etcd-certfile=${etcd_pki.client_cert.path}
              - --etcd-keyfile=${etcd_pki.client_key.path}
              - --etcd-servers=${etcd_cluster_endpoints}
              - --event-ttl=1h
              - --kubelet-certificate-authority=${pki.ca_cert.path}
              - --kubelet-client-certificate=${pki.apiserver_cert.path}
              - --kubelet-client-key=${pki.apiserver_key.path}
              - --kubelet-preferred-address-types=InternalDNS,InternalIP
              - --runtime-config=api/all=true
              - --secure-port=${apiserver_port}
              - --service-account-issuer=https://kubernetes.default.svc
              - --service-account-key-file=${pki.service_account_cert.path}
              - --service-account-signing-key-file=${pki.service_account_key.path}
              - --service-cluster-ip-range=${kubernetes_service_prefix}
              - --tls-cert-file=${pki.apiserver_cert.path}
              - --tls-private-key-file=${pki.apiserver_key.path}
              - --v=2
              env:
              - name: NODE_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.hostIP
              volumeMounts:
              - name: certs
                mountPath: ${pki_path}
                readOnly: true
              livenessProbe:
                httpGet:
                  scheme: HTTPS
                  host: 127.0.0.1
                  port: ${apiserver_port}
                  path: /healthz
                initialDelaySeconds: 15
                timeoutSeconds: 15
              readinessProbe:
                httpGet:
                  scheme: HTTPS
                  host: 127.0.0.1
                  port: ${apiserver_port}
                  path: /readyz
                initialDelaySeconds: 15
                timeoutSeconds: 15
            volumes:
            - name: certs
              hostPath:
                path: ${pki_path}