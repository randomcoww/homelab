---
variant: fcos
version: 1.5.0
storage:
  files:
    - path: ${keepalived_config_path}/20-gateway.conf
      mode: 0644
      contents:
        inline: |
          vrrp_instance gateway {
            nopreempt
            state BACKUP
            advert_int 0.1
            virtual_router_id ${virtual_router_id}
            interface ${interfaces.sync.interface_name}
            priority 250
            garp_master_delay 1
            garp_master_refresh 1
            virtual_ipaddress {
              %{~ for _, service in keepalived_services ~}
              ${service.ip} dev ${service.dev} use_vmac no_track
              %{~ endfor ~}
            }
            virtual_rules {
              to all lookup ${vrrp_master_default_route.table_id} priority ${vrrp_master_default_route.table_priority}
            }
          }

    # Create fallback route so backup node can access the internet through the wan interface
    - path: /etc/systemd/network/20-${interfaces.wan.interface_name}.network.d/20-master-default-route.conf
      mode: 0644
      contents:
        inline: |
          [DHCP]
          Anonymize=true
          RequestBroadcast=true
          UseMTU=true
          UseDNS=false
          UseNTP=false
          SendHostname=false
          UseHostname=false
          UseDomains=false
          UseTimezone=false
          ClientIdentifier=mac
          RouteTable=${vrrp_master_default_route.table_id}
    # Set global DNS - DNS via DHCP only resolves through the wan link when using systemd-resolve
    - path: /etc/systemd/resolved.conf.d/10-gateway-dns.conf
      mode: 0644
      contents:
        inline: |
          [Resolve]
          DNS=${upstream_dns.ip}#${upstream_dns.tls_servername}
          DNSOverTLS=true
    - path: /etc/systemd/network/20-${interfaces.lan.interface_name}.network.d/20-slave-default-route.conf
      mode: 0644
      contents:
        inline: |
          [Route]
          Scope=global
          Gateway=${cidrhost(interfaces.lan.prefix, interfaces.lan.netnums.gateway)}
          GatewayOnLink=true
          Destination=0.0.0.0/0
          Table=${vrrp_slave_default_route.table_id}

          [RoutingPolicyRule]
          Table=${vrrp_slave_default_route.table_id}
          Priority=${vrrp_slave_default_route.table_priority}