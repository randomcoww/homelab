timezone --utc ${timezone}
selinux --disabled
part / --size 20480 --fstype ext4

## Not used for live images. Add this to lorax template.
# bootloader --append="rd.live.image elevator=noop intel_iommu=on amd_iommu=on iommu=pt rd.live.ram=1 plymouth.enable=0 rd.plymouth=0 rd.driver.blacklist=nouveau modprobe.blacklist=nouveau clearcpuid=514"

repo --name=rpmfusion-free --metalink=https://mirrors.rpmfusion.org/metalink?repo=free-fedora-$releasever&arch=$basearch
repo --name=rpmfusion-free-updates --metalink=https://mirrors.rpmfusion.org/metalink?repo=free-fedora-updates-released-$releasever&arch=$basearch
repo --name=rpmfusion-nonfree --metalink=https://mirrors.rpmfusion.org/metalink?repo=nonfree-fedora-$releasever&arch=$basearch
repo --name=rpmfusion-nonfree-updates --metalink=https://mirrors.rpmfusion.org/metalink?repo=nonfree-fedora-updates-released-$releasever&arch=$basearch

repo --name=kubernetes --baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch
repo --name=code --baseurl=https://packages.microsoft.com/yumrepos/vscode
repo --name=winehq --baseurl=https://dl.winehq.org/wine-builds/fedora/31
# repo --name=kernel-vanilla-stable --baseurl=http://repos.fedorapeople.org/repos/thl/kernel-vanilla-mainline/fedora-$releasever/$basearch

%packages

@fonts
@gnome-desktop
@hardware-support
@printing
@base-x
kernel-devel
kernel-headers

hdparm
ipmitool
pciutils
usbutils
lm_sensors
nmap
ldns-utils
openssl
jq
net-tools
unzip
unrar
p7zip
vdpauinfo
libva-vdpau-driver
libva-utils

libvirt-daemon-kvm
libvirt-client
libvirt-devel
virt-viewer
ksmtuned
podman
fuse-overlayfs
slirp4netns

xclip
vim-enhanced
git
golang
kubectl
code
mpv
youtube-dl
awscli
gimp
vlc
ncmpcpp
firefox
lorax-lmc-novirt
xorriso

## gaming
steam
lutris
gnutls
gnutls-devel
openldap
openldap-devel
libgpg-error
sqlite2.i686
sqlite2.x86_64
winehq-staging

-gnome-boxes
-gnome-initial-setup

%end

user --name=${user} --password=${bcrypt(password)} --iscrypted --uid=${uid} --groups=wheel,libvirt --homedir=${persistent_home_path}/${user}

%post --erroronfail

##############################################
## networkd
##############################################

cat <<EOF > /etc/systemd/network/80-wl.network
[Match]
Name=wl*

[Link]
Unmanaged=true
EOF

##
## allocate vlan interfaces to hardware
##

cat <<EOF > /etc/systemd/network/10-hw.network
[Match]
MACAddress=${join(" ", [
  for h in hosts :
  h.host_network.hw.mac
])}

[Link]
ARP=no
MTUBytes=${mtu}

[Network]
LinkLocalAddressing=no
DHCP=no
%{ for k in vlans ~}
VLAN=${networks[k].br_if}
%{ endfor ~}
EOF

%{ for k in vlans ~}
##
## vlan ${k}
##

cat <<EOF > /etc/systemd/network/10-${networks[k].br_if}.netdev
[NetDev]
Name=${networks[k].br_if}
Kind=vlan

[VLAN]
Id=${networks[k].id}
EOF

%{ for h in hosts ~}
%{ if lookup(h.host_network, k, null) != null ~}
## host macvtap on vlan ${k}
cat <<EOF > /etc/systemd/network/10-${networks[k].br_if}-${h.host_network.hw.mac}.network
[Match]
Name=${networks[k].br_if}
MACAddress=${h.host_network.hw.mac}

[Link]
ARP=yes
MTUBytes=${mtu}

[Network]
LinkLocalAddressing=no
DHCP=yes

[Address]
Address=${h.host_network[k].ip}/${networks[k].cidr}
EOF

%{ endif ~}
%{ endfor ~}
%{ endfor ~}
##############################################
## persistent home directory
##############################################

mkdir -p ${persistent_home_path}

cat <<EOF > /etc/systemd/system/${join("-", compact(split("/", persistent_home_path)))}.mount
[Unit]
Before=local-fs.target
ConditionPathExists=${persistent_home_dev}

[Mount]
What=${persistent_home_dev}
Where=${persistent_home_path}

[Install]
WantedBy=local-fs.target
EOF

##############################################
## trust internal CA
##############################################

cat <<EOF > ${internal_tls_path}/internal-ca.pem
${tls_internal_ca}
EOF

update-ca-trust

##############################################
## enable services
##############################################

systemctl enable \
  libvirtd ksm ksmtuned \
  ${join("-", compact(split("/", persistent_home_path)))}.mount

systemctl set-default graphical.target

%end
