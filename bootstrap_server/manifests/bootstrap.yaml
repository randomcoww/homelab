
kind: Pod
apiVersion: v1
metadata:
  name: bootstrap
spec:
  hostNetwork: true
  initContainers:
  - name: config-writer
    image: ${container_images.kea}
    env:
    - name: ca
      value: |
        ${indent(8, ca)}
    - name: cert
      value: |
        ${indent(8, cert)}
    - name: key
      value: |
        ${indent(8, key)}
    - name: kea_config
      value: |
        ${indent(8, jsonencode(kea_config))}
    command:
    - "sh"
    - "-c"
    - |
      echo -e "$ca" > ${config_path}/ca.crt && \
      echo -e "$cert" > ${config_path}/server.crt && \
      echo -e "$key" > ${config_path}/server.key && \
      echo -e "$kea_config" > ${config_path}/kea-dhcp4.conf
    volumeMounts:
    - name: config
      mountPath: ${config_path}
  containers:
  - name: kea
    image: ${container_images.kea}
    args:
    - "kea-dhcp4"
    - "-c"
    - "${config_path}/kea-dhcp4.conf"
    securityContext:
      capabilities:
        add:
        - NET_RAW
    volumeMounts:
    - name: config
      mountPath: ${config_path}
  - name: tftpd
    image: ${container_images.tftpd}
    args:
    - "--address"
    - "0.0.0.0:${ports.pxe_tftp}"
    - "--verbose"
    securityContext:
      capabilities:
        add:
        - SYS_CHROOT
        - SETUID
        - SETGID
  - name: matchbox
    image: ${container_images.matchbox}
    args:
    - "-address=0.0.0.0:${ports.matchbox}"
    - "-rpc-address=127.0.0.1:${ports.matchbox_api}"
    - "-ca-file=${config_path}/ca.crt"
    - "-cert-file=${config_path}/server.crt"
    - "-key-file=${config_path}/server.key"
    volumeMounts:
    - name: config
      mountPath: ${config_path}
    - name: assets
      mountPath: /var/lib/matchbox/assets
  volumes:
  - name: config
    emptyDir:
      medium: Memory
  - name: assets
    hostPath:
      path: ${assets_path}
