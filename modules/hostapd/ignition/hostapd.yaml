---
variant: fcos
version: 1.4.0
systemd:
  units:
    - name: systemd-rfkill.service
      mask: true
    - name: systemd-rfkill.socket
      mask: true
    # rfkill can trip any time... try unblocking before each hostapd start
    - name: hostapd.service
      enabled: true
      dropins:
        - name: 10-dependency.conf
          contents: |
            [Service]
            Restart=always
            RestartSec=6
            EnvironmentFile=
            Environment=OTHER_ARGS="-d"
            ExecStartPre=/usr/sbin/rfkill unblock wlan

storage:
  files:
    # Roaming reference (untested)
    # https://www.reddit.com/r/ledeproject/comments/6o8skj/nearly_working_80211r_ft_roaming/
    - path: /etc/hostapd/hostapd.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |-
          interface=${interface_name}
          preamble=1
          hw_mode=g
          channel=4
          auth_algs=1
          driver=nl80211
          ieee80211ac=1
          ieee80211n=1
          require_ht=1
          wmm_enabled=1
          ht_capab=${join("", [
            for cap in ht_capab :
            "[${cap}]"
          ])}
          wpa=2
          wpa_key_mgmt=SAE
          wpa_pairwise=CCMP
          ieee80211w=2
          sae_password=${passphrase}
          ssid=${ssid}
          ctrl_interface=/var/run/hostapd
          ctrl_interface_group=0

          bssid=${bssid}
          mobility_domain=${mobility_domain}
          pmk_r1_push=1
          r0_key_lifetime=10000
          r1_key_holder=${nas_identifier}
          nas_identifier=${nas_identifier}
          %{~ for member in roaming_members ~}
          r0kh=${member.bssid} ${member.nas_identifier} ${encryption_key}
          r1kh=${member.bssid} ${member.bssid} ${encryption_key}
          %{~ endfor ~}