---
variant: fcos
version: 1.4.0
systemd:
  units:
    - name: systemd-rfkill.service
      mask: true
    - name: systemd-rfkill.socket
      mask: true
    - name: hostapd.service
      enabled: true
      dropins:
        - name: 10-dependency.conf
          contents: |
            [Service]
            Restart=always
            RestartSec=3
            EnvironmentFile=
            Environment=OTHER_ARGS="-d"
            ExecStartPre=/usr/sbin/rfkill unblock wlan

storage:
  files:
    - path: /etc/sysctl.d/99-wlan-bridge.conf
      mode: 0644
      contents:
        inline: |
          net.bridge.bridge-nf-call-iptables=0
          net.bridge.bridge-nf-call-ip6tables=0

    # - path: ${static_pod_manifest_path}/hostapd.yaml
    #   mode: 0644
    #   contents:
    #     inline: |-
    #       ---
    #       kind: Pod
    #       apiVersion: v1
    #       metadata:
    #         namespace: kube-system
    #         name: hostapd
    #       spec:
    #         hostNetwork: true
    #         restartPolicy: Always
    #         containers:
    #         - name: hostapd
    #           image: ${hostapd_container_image}
    #           args:
    #           - -d
    #           - /etc/hostapd/hostapd.conf
    #           securityContext:
    #             privileged: true
    #           volumeMounts:
    #           - name: hostapd-config
    #             mountPath: /etc/hostapd/hostapd.conf
    #             readOnly: true
    #         volumes:
    #         - name: hostapd-config
    #           hostPath:
    #             path: /etc/hostapd/hostapd.conf

    - path: /etc/hostapd/hostapd.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |-
          interface=${hardware_interface_name}
          hw_mode=g
          channel=4
          auth_algs=1
          driver=nl80211
          ieee80211n=1
          ieee80211ac=1
          wmm_enabled=1
          wpa=2
          wpa_key_mgmt=WPA-PSK
          wpa_pairwise=TKIP
          rsn_pairwise=CCMP
          wpa_passphrase=${passphrase}
          ssid=${ssid}
          ieee80211n=1
          wmm_enabled=1
          bridge=${br_interface_name}

    # For bridging to wired NIC e.g. wlan0
    # This fails until hostapd sets it the first time - this gets added if networkd is later restarted
    - path: /etc/systemd/network/20-${hardware_interface_name}.network.d/10-bridge.conf
      mode: 0644
      contents:
        inline: |
          [Network]
          Bridge=${br_interface_name}

    # For bridging to wired NIC e.g. phy0-wlan
    - path: /etc/systemd/network/20-${source_interface_name}.network.d/10-bridge.conf
      mode: 0644
      contents:
        inline: |
          [Network]
          Bridge=${br_interface_name}

    # Bridge them together e.g. br-wlan
    # This interface will have a macvtap created with IP for gateway and DHCP
    - path: /etc/systemd/network/12-${br_interface_name}.netdev
      mode: 0644
      contents:
        inline: |
          [NetDev]
          Name=${br_interface_name}
          Kind=bridge
    - path: /etc/systemd/network/20-${br_interface_name}.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=${br_interface_name}

          [Link]
          ARP=false

          [Network]
          LinkLocalAddressing=false
          DHCP=false