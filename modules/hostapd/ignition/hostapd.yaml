---
variant: fcos
version: 1.4.0
systemd:
  units:
    - name: systemd-rfkill.service
      mask: true
    - name: systemd-rfkill.socket
      mask: true
    # Find a better way to do this #
    - name: rfkill-unblock.service
      enabled: true
      contents: |
        [Unit]
        Before=systemd-networkd.service
        WantedBy=systemd-networkd.service

        [Service]
        Type=oneshot
        ExecStart=/usr/sbin/rfkill unblock all

        [Install]
        WantedBy=multi-user.target

storage:
  files:
    - path: /etc/udev/rules.d/10-wlan-4addr.rules
      mode: 0644
      contents:
        inline: |-
          ACTION=="add", SUBSYSTEM=="ieee80211", KERNEL=="wlp*", RUN+="/usr/sbin/iw dev %k set 4addr on"

    - path: ${static_pod_manifest_path}/hostapd.yaml
      mode: 0644
      contents:
        inline: |-
          ---
          kind: Pod
          apiVersion: v1
          metadata:
            namespace: kube-system
            name: hostapd
          spec:
            hostNetwork: true
            restartPolicy: Always
            containers:
            - name: hostapd
              image: ${hostapd_container_image}
              args:
              - -d
              - /etc/hostapd/hostapd.conf
              securityContext:
                privileged: true
              volumeMounts:
              - name: hostapd-config
                mountPath: /etc/hostapd/hostapd.conf
                readOnly: true
            volumes:
            - name: hostapd-config
              hostPath:
                path: /etc/hostapd/hostapd.conf

    - path: /etc/hostapd/hostapd.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |-
          interface=${hardware_interface_name}
          hw_mode=g
          channel=4
          auth_algs=1
          driver=nl80211
          wpa=2
          wpa_key_mgmt=WPA-PSK
          wpa_pairwise=TKIP
          rsn_pairwise=CCMP
          wpa_passphrase=${passphrase}
          ssid=${ssid}
          ieee80211n=1
          wmm_enabled=1
          ctrl_interface=/var/run/hostapd
          ctrl_interface_group=0

    # For bridging to wired NIC e.g. phy0-wlan
    - path: /etc/systemd/network/20-${hardware_interface_name}.network.d/10-bridge.conf
      mode: 0644
      contents:
        inline: |
          [Network]
          Bridge=${br_interface_name}

          [BridgeVLAN]
          EgressUntagged=90
          PVID=90

    # For bridging to wired NIC e.g. phy0-wlan
    - path: /etc/systemd/network/20-${vlan_interface_name}.network.d/10-bridge.conf
      mode: 0644
      contents:
        inline: |
          [Network]
          Bridge=${br_interface_name}

          [BridgeVLAN]
          VLAN=90

    # Bridge them together e.g. br-wlan
    # This interface will have a macvtap created with IP for gateway and DHCP
    - path: /etc/systemd/network/12-${br_interface_name}.netdev
      mode: 0644
      contents:
        inline: |
          [NetDev]
          Name=${br_interface_name}
          Kind=bridge

    - path: /etc/systemd/network/20-${br_interface_name}.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=${br_interface_name}

          [Link]
          ARP=false

          [Network]
          LinkLocalAddressing=false
          DHCP=false

          [Bridge]
          VLANFiltering=true