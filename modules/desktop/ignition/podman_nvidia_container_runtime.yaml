---
variant: fcos
version: 1.4.0
storage:
  files:
    # containerd needs `no-cgroups = false` but podman needs `no-cgroups = true`
    # /etc/containers/containers.conf.d/<config>.conf would be better here but it is not working
    - path: /etc/containers/containers.conf
      overwrite: true
      contents:
        inline: |
          [engine]
          hooks_dir=["/etc/containers/oci/hooks.d"]
    - path: /etc/nvidia-container-runtime/podman-config.toml
      overwrite: true
      contents:
        inline: |
          disable-require = false

          [nvidia-container-cli]
          environment = []
          load-kmods = true
          no-cgroups = true
          ldconfig = "@/sbin/ldconfig"
    - path: /etc/containers/oci/hooks.d/oci-nvidia-hook.json
      contents:
        inline: |
          {
            "version": "1.0.0",
            "hook": {
              "path": "/usr/bin/nvidia-container-toolkit",
              "args": [
                "nvidia-container-toolkit",
                "-config",
                "/etc/nvidia-container-runtime/podman-config.toml",
                "prestart"
              ],
              "env": [
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
              ]
            },
            "when": {
              "always": true,
              "commands": [".*"]
            },
            "stages": ["prestart"]
          }