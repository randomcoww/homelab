##
## store-* host kickstart for livecd-creator
##

skipx
lang en_US.UTF-8
keyboard us
timezone --utc Etc/UTC
auth --useshadow --passalgo=sha512
selinux --disabled
firewall --disabled
zerombr
clearpart --all --disklabel=gpt
part / --size 5120 --fstype ext4
rootpw --lock --iscrypted locked
shutdown
bootloader --append="console=tty0 console=ttyS1,115200n8 elevator=noop intel_iommu=on iommu=pt rd.live.ram=1"

repo --name=fedora --mirrorlist=https://mirrors.fedoraproject.org/mirrorlist?repo=fedora-$releasever&arch=$basearch
repo --name=updates --mirrorlist=https://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f$releasever&arch=$basearch
url --mirrorlist=https://mirrors.fedoraproject.org/mirrorlist?repo=fedora-$releasever&arch=$basearch

repo --name=kubernetes --baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch
repo --name=zfs-on-linux --baseurl=http://download.zfsonlinux.org/fedora/$releasever/$basearch/

%packages --excludedocs

## common
@core
libvirt-daemon-kvm
ksmtuned
cronie
chrony
logrotate
nfs-utils
##

zfs
-zfs-fuse
openssh-server
hdparm

## livecd-creator
kernel
dracut-live
grub2-efi-x64-cdboot
shim
##

-NetworkManager
-plymouth
-plymouth-*
%end

%post --erroronfail

##
## serial autologin
##

mkdir -p /etc/systemd/system/serial-getty@.service.d
cat <<EOF > /etc/systemd/system/serial-getty@.service.d/autologin.conf
[Service]
ExecStart=
ExecStart=-/sbin/agetty -a {{.default_user}} --keep-baud 115200,38400,9600 %I $TERM
EOF

##
## networkd
##

## enable systemd-resolve
ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf

## write all configs
cat <<EOF > /etc/systemd/resolved.conf
[Resolve]
FallbackDNS=
DNSStubListener=no
EOF

## default
cat <<EOF > /etc/systemd/network/99_en.network
[Match]
Name=en*

[Link]
ARP=no
MTUBytes={{.mtu}}

[Network]
LinkLocalAddressing=no
DHCP=no
EOF

## host macvtap
cat <<EOF > /etc/systemd/network/00_{{.host_if}}.network
[Match]
Name={{.host_if}}

[Link]
ARP=no
MTUBytes={{.mtu}}

[Network]
LinkLocalAddressing=no
DHCP=no
MACVTAP=v{{.host_if}}
EOF

cat <<EOF > /etc/systemd/network/00_v{{.host_if}}.netdev
[NetDev]
Name=v{{.host_if}}
Kind=macvtap

[MACVTAP]
Mode=bridge
EOF

cat <<EOF > /etc/systemd/network/00_v{{.host_if}}.network
[Match]
Name=v{{.host_if}}

[Link]
MTUBytes={{.mtu}}

[Network]
LinkLocalAddressing=yes
DHCP=yes
EOF

##
## general file writes
##

cat <<EOF > /etc/modprobe.d/local.conf
options igb max_vfs=8
options ixgbe max_vfs=8
EOF

cat <<EOF > /etc/ssh/authorized_keys
{{.ssh_authorized_key}}
EOF

cat <<EOF > /etc/ssh/sshd_config
Subsystem sftp internal-sftp
ClientAliveInterval 180
UseDNS no
PasswordAuthentication no
ChallengeResponseAuthentication no
AuthorizedKeysFile /etc/ssh/authorized_keys
EOF

##
## live image settings
## systemd configs from https://linux.xvx.cz/2017/07/how-to-build-pxe-fedora-26-live-image.html
## https://fedoraproject.org/wiki/LiveOS_image
##

cat <<EOF >> /etc/systemd/system.conf
DumpCore=no
EOF

cat <<EOF >> /etc/systemd/journald.conf
Storage=volatile
RuntimeMaxUse=15M
ForwardToSyslog=no
ForwardToConsole=no
EOF

##
## enable services
##

systemctl enable \
  systemd-networkd systemd-resolved chronyd crond \
  libvirtd ksm ksmtuned \
  zfs-import-cache zfs-import-scan zfs-mount zfs-share zfs-zed zfs.target nfs-server \
  sshd

systemctl mask \
  NetworkManager

systemctl set-default multi-user.target

##
## cleanup
##

dnf -y autoremove
dnf -y clean all

rm -f /etc/machine-id
touch /etc/machine-id

%end