---
variant: fcos
version: 1.4.0
storage:
  files:
    - path: ${pod_mount_path}/coredns/Corefile
      mode: 0644
      contents:
        inline: |-
          ${internal_domain}. {
            errors
            forward . ${internal_dns_ip}
          }
          . {
            errors
            health
            forward . tls://${upstream_dns_ip} {
              tls_servername ${upstream_dns_tls_servername}
              health_check 20s
            }
            cache 30
            reload
            loadbalance
          }

    - path: ${kubelet_config_path}/manifests/coredns.yaml
      mode: 0644
      contents:
        inline: |-
          ---
          apiVersion: v1
          kind: Pod
          metadata:
            namespace: kube-system
            name: coredns
          spec:
            restartPolicy: Always
            hostNetwork: true
            containers:
            - name: coredns
              image: "${container_images.coredns}"
              resources:
                limits:
                  memory: 170Mi
                requests:
                  cpu: 100m
                  memory: 70Mi
              args: [ "-conf", "/etc/coredns/Corefile" ]
              livenessProbe:
                httpGet:
                  path: /health
                  port: 8080
                  scheme: HTTP
                initialDelaySeconds: 15
                timeoutSeconds: 5
                successThreshold: 1
                failureThreshold: 5
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  add:
                  - NET_BIND_SERVICE
                  drop:
                  - all
                readOnlyRootFilesystem: true
              volumeMounts:
              - name: config-coredns
                mountPath: /etc/coredns/Corefile
                readOnly: true
            volumes:
            - name: config-coredns
              hostPath:
                path: ${pod_mount_path}/coredns/Corefile