---
variant: fcos
version: 1.4.0
systemd:
  units:
    - name: virtproxyd-tls.socket
      enabled: true
    - name: ksm.service
      enabled: true
    - name: ksmtuned.service
      enabled: true
    # PXE boot
    - name: matchbox.service
      enabled: true
      contents: |
        [Unit]
        After=network-online.target
        Wants=network-online.target
        Before=libvirtd.service
        WantedBy=libvirtd.service

        [Service]
        TimeoutStartSec=5m
        Restart=always
        RestartSec=10
        ExecStartPre=/usr/bin/mkdir -p \
          ${matchbox_data_path}
        ExecStartPre=/usr/bin/podman load -i \
          ${image_paths.matchbox} localhost/matchbox
        ExecStartPre=-/usr/bin/podman kill matchbox
        ExecStartPre=-/usr/bin/podman rm matchbox
        ExecStart=/usr/bin/podman run --rm -it \
          --name matchbox \
          --security-opt label=disable \
          --log-driver none \
          --network host \
          %{~ for cert in certs.matchbox ~}
          -v ${cert.path}:${cert.path}:ro \
          %{~ endfor ~}
          localhost/matchbox \
            -address=${internal_interface.ip}:${ports.matchbox_http} \
            -rpc-address=0.0.0.0:${ports.matchbox_rpc} \
            -ca-file=${certs.matchbox.ca.path} \
            -cert-file=${certs.matchbox.cert.path} \
            -key-file=${certs.matchbox.key.path} \
            -data-path=${matchbox_data_path} \
            -assets-path=${matchbox_assets_path}

        [Install]
        WantedBy=multi-user.target
    - name: kea-dhcp4.service
      enabled: true
      contents: |
        [Unit]
        After=network-online.target
        Wants=network-online.target
        Before=libvirtd.service
        WantedBy=libvirtd.service

        [Service]
        TimeoutStartSec=5m
        Restart=always
        RestartSec=10
        ExecStartPre=/usr/bin/podman load -i \
          ${image_paths.kea} localhost/kea
        ExecStartPre=-/usr/bin/podman kill kea-dhcp4
        ExecStartPre=-/usr/bin/podman rm kea-dhcp4
        ExecStart=/usr/bin/podman run --rm -it \
          --name kea-dhcp4 \
          --security-opt label=disable \
          --log-driver none \
          --network host \
          -v ${kea_config_path}:${kea_config_path}:ro \
          localhost/kea \
            kea-dhcp4 \
              -c ${kea_config_path}

        [Install]
        WantedBy=multi-user.target

storage:
  files:
    # Kea #
    - path: ${kea_config_path}
      mode: 0644
      contents:
        inline: |
          ${jsonencode({
            "Dhcp4" = {
              "lease-database" = {
                "type" = "memfile"
              }
              "interfaces-config" = {
                "interfaces" = [
                  "${internal_interface.name}-tap",
                ]
              }
              "client-classes" = [
                {
                  "name" = "ipxe_detected"
                  "test" = "substring(option[77].hex,0,4) == 'iPXE'"
                  "boot-file-name" = "http://${join(":", [internal_interface.ip, ports.matchbox_http])}/boot.ipxe"
                },
              ]
              "subnet4" = [
                {
                  "subnet" = internal_interface.network
                  "pools" = [
                    {
                      "pool" = internal_interface.dhcp_pool
                    },
                  ]
                },
              ]
            }
          })}

    # Internal interface #
    - path: /etc/systemd/network/10-${internal_interface.name}.netdev
      mode: 0644
      contents:
        inline: |
          [NetDev]
          Name=${internal_interface.name}
          Kind=bridge
    - path: /etc/systemd/network/12-${internal_interface.name}.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=${internal_interface.name}

          [Link]
          ARP=false

          [Network]
          LinkLocalAddressing=false
          DHCP=false
          MACVTAP=${internal_interface.name}-tap
          Bridge=${internal_interface.name}-dummy
    - path: /etc/systemd/network/10-${internal_interface.name}-dummy.netdev
      mode: 0644
      contents:
        inline: |
          [NetDev]
          Name=${internal_interface.name}-dummy
          Kind=dummy
    - path: /etc/systemd/network/12-${internal_interface.name}-dummy.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=${internal_interface.name}-dummy

          [Link]
          ARP=false

          [Network]
          LinkLocalAddressing=false
          DHCP=false
          Bridge=${internal_interface.name}

    # Tap interfaces
    - path: /etc/systemd/network/20-${internal_interface.name}-tap.netdev
      mode: 0644
      contents:
        inline: |
          [NetDev]
          Name=${internal_interface.name}-tap
          Kind=macvtap

          [MACVTAP]
          Mode=bridge
    - path: /etc/systemd/network/22-${internal_interface.name}-tap.network
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=${internal_interface.name}-tap

          [Link]
          ARP=false

          [Network]
          LinkLocalAddressing=false
          DHCP=false
          MulticastDNS=false

          [Address]
          Address=${internal_interface.address}

    # certs #
    %{~ for cert_category in values(certs) ~}
    %{~ for cert in values(cert_category) ~}
    - path: ${cert.path}
      mode: 0644
      contents:
        inline: "${replace(cert.content, "\n", "\\n")}"
    %{~ endfor ~}
    %{~ endfor ~}

passwd:
  users:
    - name: ${user}
      groups:
        - libvirt