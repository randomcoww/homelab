---
variant: fcos
version: 1.4.0
systemd:
  units:
    - name: crio.service
      enabled: true
    - name: kubelet.service
      enabled: true
      contents: |
        [Unit]
        Description=Kubelet via Hyperkube
        After=network.target containerd.service
        Wants=containerd.service

        [Service]
        Environment=KUBELET_PODMAN_OPTS="--name kubelet \
          --security-opt label=disable \
          --log-driver none \
          --network host \
          --pid host \
          --ipc host \
          --privileged \
          -v /run:/run \
          -v /dev:/dev \
          -v /etc/ssl/certs:/etc/ssl/certs:ro \
          -v /etc/pki/ca-trust:/etc/pki/ca-trust:ro \
          -v /usr/lib/modules:/lib/modules:ro \
          -v /etc/machine-id:/etc/machine-id:ro \
          -v /usr/lib/os-release:/etc/os-release \
          -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
          -v /sys/fs/cgroup/systemd:/sys/fs/cgroup/systemd \
          -v /var/lib/crio:/var/lib/crio:z \
          -v /opt/cni/bin:/opt/cni/bin:z \
          -v ${kubelet_config_path}:${kubelet_config_path}:rshared,z \
          -v ${static_pod_manifest_path}:${static_pod_manifest_path}:rshared,z \
          -v ${static_pod_config_path}:${static_pod_config_path}:rshared,z \
          -v /var/log:/var/log \
          -v /var/run/lock:/var/run/lock:z"
        Environment=KUBELET_COMMON_ARGS="--exit-on-lock-contention \
          --lock-file=/var/run/lock/kubelet.lock \
          --fail-swap-on=false \
          --container-runtime=remote \
          --container-runtime-endpoint=unix:///run/crio/crio.sock \
          --runtime-request-timeout=10m \
          --node-ip=${try(cidrhost(network_prefix, host_netnum), "")} \
          --v=2"
        ExecStartPre=/usr/bin/mkdir -p \
          ${kubelet_config_path} \
          /var/log/containers \
          /opt/cni/bin
        ExecStartPre=-/usr/bin/podman kill kubelet
        ExecStartPre=-/usr/bin/podman rm kubelet
        ExecStart=/usr/bin/podman run --rm -it \
          $KUBELET_PODMAN_OPTS \
          ${kubelet_container_image} \
            kubelet \
              $KUBELET_COMMON_ARGS \
              --config=${kubelet_config_path}/kubelet-config.yaml \
              --register-node=false
        Restart=always
        RestartSec=10
        Delegate=true

        [Install]
        WantedBy=multi-user.target

storage:
  files:
    - path: /etc/crio/crio.conf.d/10-custom.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |-
          [crio.runtime]
          default_runtime="crun"
          conmon_cgroup="pod"
          cgroup_manager="cgroupfs"

          [crio.runtime.runtimes.crun]
          runtime_path="/usr/bin/crun"

          [crio.network]
          plugin_dirs=["/usr/libexec/cni/","/opt/cni/bin/"]

    - path: ${kubelet_config_path}/kubelet-config.yaml
      mode: 0644
      contents:
        inline: |-
          kind: KubeletConfiguration
          apiVersion: kubelet.config.k8s.io/v1beta1
          authentication:
            anonymous:
              enabled: true
            webhook:
              enabled: false
          authorization:
            mode: AlwaysAllow
          enableServer: false
          staticPodPath: ${static_pod_manifest_path}
          makeIPTablesUtilChains: false
          containerLogMaxSize: "10Mi"
          containerLogMaxFiles: 2