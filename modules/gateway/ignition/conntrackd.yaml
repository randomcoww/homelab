
---
variant: fcos
version: 1.4.0
storage:
  files:
    - path: ${static_pod_config_path}/conntrackd/conntrackd.conf
      mode: 0644
      contents:
        inline: |-
          Sync {
            Mode NOTRACK {
              StartupResync on
              DisableInternalCache on
              DisableExternalCache on
            }
            Multicast {
              IPv4_address 225.0.0.50
              Group 3780
              IPv4_interface ${cidrhost(interfaces.sync.prefix, host_netnum)}
              Interface ${interfaces.sync.interface_name}
              SndSocketBuffer 24985600
              RcvSocketBuffer 24985600
              Checksum on
            }
          }
          General {
            Systemd off
            LogFile /dev/stdout
            Syslog off
            NetlinkBufferSize 2097152
            NetlinkBufferSizeMaxGrowth 8388608
            UNIX {
              Path /var/run/conntrackd.ctl
            }
            Filter From Kernelspace {
              Protocol Accept {
                TCP
                UDP
              }
              Address Ignore {
                IPv4_address 127.0.0.1
                IPv4_address ${cidrhost(interfaces.sync.prefix, host_netnum)}/${interfaces.sync.cidr}
                %{~ for network_name, interface in interfaces ~}
                %{~ if lookup(interface, "enable_netnum", false) ~}
                IPv4_address ${cidrhost(interface.prefix, host_netnum)}
                %{~ endif ~}
                %{~ if lookup(interface, "enable_vrrp_netnum", false) ~}
                IPv4_address ${cidrhost(interface.prefix, vrrp_netnum)}
                %{~ endif ~}
                %{~ endfor ~}
              }
            }
          }
    # pod manifests #
    - path: ${static_pod_manifest_path}/conntrackd.yaml
      mode: 0644
      contents:
        inline: |-
          ---
          apiVersion: v1
          kind: Pod
          metadata:
            namespace: kube-system
            name: conntrackd
          spec:
            restartPolicy: Always
            hostNetwork: true
            containers:
            - name: conntrackd
              image: ${container_images.conntrackd}
              args: [ "-C", "/etc/conntrackd/conntrackd.conf" ]
              securityContext:
                capabilities:
                  add:
                  - NET_ADMIN
                  - SYS_NICE
              volumeMounts:
              - name: config-volume
                mountPath: /etc/conntrackd/conntrackd.conf
                readOnly: true
            volumes:
            - name: config-volume
              hostPath:
                path: ${static_pod_config_path}/conntrackd/conntrackd.conf